window.flakes = new Array(
    "<%= asset_path('weather/flakes/flake1.gif')%>",
    "<%= asset_path('weather/flakes/flake2.gif')%>",
    "<%= asset_path('weather/flakes/flake3.gif')%>",
    "<%= asset_path('weather/flakes/flake4.gif')%>",
    "<%= asset_path('weather/flakes/flake5.gif')%>"
)

window.amp = new Array();
window.x_pos = new Array();
window.y_pos = new Array();
window.stx = new Array();
window.sty = new Array();
window.deltax = new Array();
window.obj = new Array();

window.show_started = false

window.flake = ->
  doc = document.documentElement;
  left = (window.pageXOffset || doc.scrollLeft) - (doc.clientLeft || 0);
  top = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);
  uwidth = window.innerWidth
  uheight = window.innerHeight

  for i in [obj.length-1..0]
    y_pos[i] += sty[i]
    if y_pos[i] < top || y_pos[i] > top + uheight - 55 || x_pos[i] < left || x_pos[i] > left + uwidth
      if (window.show_started)
        x_pos[i] = Math.random() * (left + uwidth - amp[i])
        y_pos[i] = top
      else
        document.body.removeChild(obj.splice(i, 1)[0]);
        continue

    deltax[i] += stx[i]
    obj[i].style.top = y_pos[i] + 'px'
    obj[i].style.left = x_pos[i] + amp[i] * Math.sin(deltax[i]) + 'px'

  if (obj.length > 0)
    setTimeout 'flake()', 100


window.init_snow = (amount = window.innerWidth * window.innerHeight / 10000) ->
  amount = Math.max(10, amount)
  while(obj.length > amount)

    document.body.removeChild(obj.pop());

  while(obj.length < amount)
    i = obj.length
    amp[i] = Math.random() * 19
    x_pos[i] = Math.random() * (window.innerWidth - amp[i])
    y_pos[i] = Math.random() * window.innerHeight
    stx[i] = 0.03 + Math.random() * 0.25
    sty[i] = 3 + Math.random()
    deltax[i] = 0
    new_flake = document.createElement('img')
    new_flake.setAttribute('id', "sn#{i}")
    new_flake.setAttribute('style', "position:absolute; z-index: -1; visibility:visible; top:-50px; left:-50px;")
    new_flake.setAttribute('src', flakes[Math.floor(Math.random() * flakes.length)])
    document.body.appendChild(new_flake);
    obj[i] = new_flake

window.snowfall = (amount) ->
  init_snow(amount)
  if (!window.show_started)
    window.show_started = true
    flake()

window.stopSnowfall = ->
    window.show_started = false

$ ->
